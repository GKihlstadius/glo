## Codebase Patterns
- Use NativeWind (Tailwind) for styling with cn() helper from src/lib/cn.ts for conditional classes
- expo-av Video component for native video playback
- Zustand for local state management (src/lib/store.ts)
- TMDB API integration in src/lib/tmdb.ts
- Existing trailer system code in src/lib/trailer.ts and src/lib/trailer-system.ts (currently disabled)
- MovieCard component at src/components/MovieCard.tsx
- SwipeCard component at src/components/SwipeCard.tsx handles gestures
- Spelläge screen at src/app/spellage.tsx

- TrailerPlayer persistent player architecture at src/components/TrailerPlayer.tsx
- TrailerSource type: { type: 'native' | 'youtube' | 'apple', uri: string, startTime?: number, endTime?: number }
- useTrailerSource(movieId) hook at src/lib/useTrailerSource.ts for fetching trailer sources
- TrailerGate module at src/lib/trailer-gate.ts for autoplay stability tracking
- getNativeTrailerSource(movie) at src/lib/native-trailer-source.ts for MP4/HLS sources
- getYouTubeTrailerSource(movie) at src/lib/youtube-trailer-source.ts for YouTube embeds
- YouTube embeds use youtube-nocookie.com for privacy-enhanced playback
- isVideoEmbeddable(videoId) uses oEmbed API to validate embed availability
- getAppleTrailerSource(movie) at src/lib/apple-trailer-source.ts for Apple Movie Previews
- Apple iTunes Search API returns previewUrl for movie trailers (HLS/M4V format)
- Apple sources return type 'apple' to distinguish from native (type 'native') sources
- Trailer system integration test at src/lib/trailer-test.ts - call initializeTrailerSystem() at app start
- isTrailerSystemEnabled() check required before triggering any trailer playback
- Together mode waiting room at src/app/waiting-room.tsx with QR code and share functionality
- Session type has extended fields for Together mode: hostDeviceId, movies[], currentRound, totalRounds, matches[]
- generateSessionMovies(countryCode, mood, count) in movies.ts for pre-generating round movies
- Deep link format for joining: vibecode://join/{code} (NOT glo://)
- Session registry at src/lib/session-registry.ts for storing/validating sessions
- Join flow: src/app/join.tsx (manual entry) and src/app/join/[code].tsx (deep link handler)
- registerSession() should be called when creating Together mode sessions
- useSessionMovies(session, countryCode) hook at src/lib/useSessionMovies.ts for synchronized feed
- Together mode uses session.movies[] array; Solo mode uses FeedEngine
- recordSwipeToSession() syncs swipes to session.swipes and updates registry
- isTogetherMode = session exists AND !session.spellageSolo

---

## 2026-01-21 - US-001
- What was implemented: Persistent Video Player Architecture
- Files changed: src/components/TrailerPlayer.tsx (new)
- **Learnings for future iterations:**
  - expo-av Video component is used for native video playback, though it's deprecated in favor of expo-video
  - The player uses imperative API via forwardRef/useImperativeHandle pattern
  - Visibility controlled via opacity (not mount/unmount) for instant control
  - z-index 100 places player above card stack
  - stopAsync() is called without await for <16ms instant stop requirement
---

## 2026-01-21 - US-002
- What was implemented: Source-Agnostic Video Loader
- Files changed: src/lib/useTrailerSource.ts (new)
- **Learnings for future iterations:**
  - useTrailerSource hook uses React Query for data fetching and caching
  - AsyncStorage used for persistent 7-day TTL cache
  - Sources checked in priority order: native > YouTube > Apple
  - Negative results (null) are also cached to avoid repeated lookups
  - Uses React Query's staleTime and gcTime for in-memory caching
  - getTrailer() from trailer.ts expects full Movie type but only uses movie.id - use createMinimalMovie helper
  - Re-export TrailerSource type from useTrailerSource for convenience
---

## 2026-01-21 - US-003
- What was implemented: Autoplay Gate System
- Files changed: src/lib/trailer-gate.ts (new)
- **Learnings for future iterations:**
  - Gate requires 50 consecutive successes for both autoplay and swipeStop
  - Session failure is tracked in-memory only (doesn't persist across restarts)
  - Metrics persist to AsyncStorage but reset on app version update
  - recordBlinkStop() treats videos stopping within 2 seconds as failures
  - Gate state can be checked synchronously via isGatePassed()
---

## 2026-01-21 - US-004
- What was implemented: Native Video Source Integration (MP4/HLS)
- Files changed: src/lib/native-trailer-source.ts (new), src/lib/useTrailerSource.ts (updated)
- **Learnings for future iterations:**
  - TMDB API does NOT provide direct MP4/HLS URLs - only YouTube/Vimeo video keys
  - Apple iTunes Search API can be used to find movie preview URLs (HLS streams)
  - The useTrailerSource hook only receives movieId, not full Movie object - limits native source lookup
  - For full Apple iTunes search, need movie title and year (createMinimalMovie has empty values)
  - URL validation uses HEAD request to check content-type for video MIME types
  - CDN_PATTERNS array is extensible for future studio-specific CDN integrations
  - Native sources have priority over YouTube/Apple in the trailer source resolution
---

## 2026-01-21 - US-005
- What was implemented: YouTube Source Integration
- Files changed: src/lib/youtube-trailer-source.ts (new), src/lib/useTrailerSource.ts (updated)
- **Learnings for future iterations:**
  - youtube-nocookie.com provides privacy-enhanced embeds (no tracking cookies)
  - YouTube oEmbed API at youtube.com/oembed can check embeddability without API key
  - Video ID format is 11 characters: letters, numbers, hyphens, underscores
  - Embed parameters: autoplay=1, mute=1, playsinline=1, controls=0 for clean inline playback
  - enablejsapi=1 allows JavaScript control of embedded player
  - getTrailer() from trailer.ts provides official trailer lookup with channel priority
  - Embeddability validation prevents showing blocked/unavailable videos
---

## 2026-01-21 - US-006
- What was implemented: Apple Movie Previews Integration
- Files changed: src/lib/apple-trailer-source.ts (new), src/lib/useTrailerSource.ts (updated)
- **Learnings for future iterations:**
  - Apple iTunes Search API endpoint: https://itunes.apple.com/search?term={query}&media=movie&entity=movie
  - previewUrl field contains HLS/M4V video URL for trailer playback
  - Best match found by scoring title similarity (exact match > contains > word overlap) and year proximity
  - Apple preview URLs come from domains like video-ssl.itunes.apple.com, is{N}-ssl.mzstatic.com
  - HEAD request validation can be lenient for Apple URLs - pattern matching is sufficient fallback
  - transformToHlsUrl() can convert .mp4 to .m4v for better quality
  - Apple sources return type 'apple' distinct from 'native' type used by other HLS sources
  - getAppleSourceByTrackId() available for direct track ID lookup via itunes.apple.com/lookup
- useAutoplay(options) hook at src/lib/useAutoplay.ts for autoplay timing and triggering
- Random delay between 900-1400ms per spec for natural autoplay feel
- Autoplay conditions: isTopCard + hasTrailerSource + gatePassed + !isGestureActive
- onGestureStart() immediately cancels any pending autoplay
- 300ms debounce after swipe to prevent autoplay during rapid swiping
- recordAutoplayStarted()/recordAutoplayFailed() for gate metric tracking
- useSwipeStop hook at src/lib/useSwipeStop.ts for instant trailer stop on swipe
- SwipeCard accepts onGestureStart/onGestureEnd props for trailer integration
- performance.now() used for precise timing measurement of stop operations
- Stop operations failing >100ms threshold are recorded as failures to gate
- usePosterFallback(options) hook at src/lib/usePosterFallback.ts for graceful fallback behavior
- Blink-stop threshold: 2000ms - videos stopping within this time are recorded as failures
- Loading state capped at 500ms maximum display time
- Poster always visible as base layer; player overlays poster when ready
---

## 2026-01-21 - US-007
- What was implemented: Autoplay Delay & Trigger Logic
- Files changed: src/lib/useAutoplay.ts (new)
- **Learnings for future iterations:**
  - useAutoplay hook handles WHEN to play, not the actual playback
  - Autoplay conditions checked: isTopCard, hasTrailerSource, gatePassed, !isGestureActive
  - Random delay (900-1400ms) prevents mechanical feel
  - Debounce prevents autoplay during rapid swiping (300ms after last swipe)
  - Gate checked twice: once at start, once after delay (could fail during delay)
  - onGestureStart() must be called from gesture handler's onStart for instant cancellation
  - hasAutoplayedRef prevents multiple triggers per card
  - reset() should be called when movie changes to allow new autoplay
  - State changes use functional updates to avoid stale closures
---

## 2026-01-23 - US-009
- What was implemented: Poster Fallback Behavior
- Files changed: src/lib/usePosterFallback.ts (new), src/components/TrailerPlayer.tsx (updated)
- **Learnings for future iterations:**
  - usePosterFallback hook manages all fallback states and blink-stop detection
  - Blink-stop: video stopping within 2 seconds of starting is recorded as failure
  - recordBlinkStop() from trailer-gate.ts marks session as failed
  - Loading state capped at 500ms (MAX_LOADING_TIME_MS constant)
  - Poster is always showPoster=true (constant) - it's the base layer
  - showPlayer controls whether TrailerPlayer overlays the poster
  - onLoadStart/onLoadComplete callbacks added to TrailerPlayer for timing integration
  - Silent error handling: onLoadError hides player without any error UI
  - shouldShowPlayer() helper method checks all conditions (source, errors, blink-stops)
  - State resets automatically when movieId changes via useEffect
---

## 2026-01-23 - US-010
- What was implemented: Trailer System Integration Test
- Files changed: src/lib/trailer-test.ts (new)
- **Learnings for future iterations:**
  - runTrailerSystemTests() is the main test function that runs 50 autoplay + 50 swipe-stop simulations
  - initializeTrailerSystem() is the entry point for app initialization - runs tests and enables if passed
  - isTrailerSystemEnabled() check should be used before triggering any trailer playback
  - Test logs are prefixed with [TrailerTest][timestamp] for easy filtering in expo.log
  - simulateSwipeStop() returns realistic timing distribution (95% instant, 4% slow, 1% near-threshold)
  - STOP_FAILURE_THRESHOLD_MS = 100ms matches useSwipeStop.ts threshold
  - BLINK_STOP_THRESHOLD_MS = 2000ms matches usePosterFallback.ts threshold
  - forceEnableTrailerSystem() available for dev/testing but should not be used in production
  - getTrailerSystemStatus() returns enabled state + gate status + metrics for debugging
---

## 2026-01-23 - US-011
- What was implemented: Spelläge Entry Flow Redesign
- Files changed: src/app/spellage.tsx (updated)
- **Learnings for future iterations:**
  - react-native-reanimated v3 for smooth animations (withSpring, withTiming, withDelay)
  - AnimatedPressable created via Animated.createAnimatedComponent(Pressable)
  - Staggered entrance animations create premium feel (100ms, 150ms, 300ms, 400ms delays)
  - useAnimatedStyle hook returns style object with transform arrays
  - interpolate() for mapping animation progress to transform values
  - Card-based UI with subtle borders (rgba(255,255,255,0.06)) and glow effects
  - Mode selection: Solo (User icon) and Together (Users icon with Heart badge)
  - Exit animations before step change (withTiming 200ms, then setTimeout 220ms for state change)
  - footerHint with italic text for subtle messaging about blind choice
  - Mood selection preserved from original design but with updated styling
---

## 2026-01-23 - US-012
- What was implemented: Together Mode - Session Creation
- Files changed:
  - src/lib/types.ts (updated Session type with new fields)
  - src/lib/movies.ts (added generateSessionMovies function)
  - src/app/spellage.tsx (updated session creation logic)
  - src/app/_layout.tsx (added waiting-room route)
  - src/app/waiting-room.tsx (new)
- **Learnings for future iterations:**
  - Session type now includes: hostDeviceId, movies[], currentRound, totalRounds, matches[]
  - generateSessionMovies(countryCode, mood, count) pre-generates movie list for session
  - Waiting room screen shows room code with copy functionality via expo-clipboard
  - QR code generated using react-native-svg with deterministic pattern from code
  - Deep link format: glo://join/{code} - to be handled in US-013
  - Share API via React Native Share module for native share sheet
  - Pulse animation using withRepeat(withTiming(...), -1, true) for waiting indicator
  - Route registration in _layout.tsx with gestureEnabled: false to prevent back swipe
  - Session status 'waiting' used for Together mode before game starts
---

## 2026-01-23 - US-013
- What was implemented: Together Mode - Join via Link/QR
- Files changed:
  - src/lib/session-registry.ts (new) - session storage and join validation
  - src/app/join.tsx (new) - manual code entry screen
  - src/app/join/[code].tsx (new) - deep link handler for vibecode://join/{code}
  - src/app/spellage.tsx (updated) - added "Join a room" link, register session on creation
  - src/app/waiting-room.tsx (updated) - changed deep link from glo:// to vibecode://
  - src/app/_layout.tsx (updated) - registered join and join/[code] routes
- **Learnings for future iterations:**
  - Deep link scheme is 'vibecode' (from app.json), not 'glo' - use vibecode://join/{code}
  - Expo Router dynamic routes: src/app/join/[code].tsx handles vibecode://join/ABC123
  - Session registry uses AsyncStorage with SESSION_PREFIX for storage
  - validateJoinCode() returns detailed error types: not_found, expired, already_started, full
  - joinSession() handles both new joins and re-joins (idempotent)
  - Code entry boxes use hidden TextInput with visible Pressable boxes overlay
  - Error messages are localized (sv/en) based on country.language
  - Join screen navigates to /session after successful join
  - Dynamic route screen shows status feedback (joining/success/error) with animations
---

## 2026-01-23 - US-014
- What was implemented: Together Mode - Synchronized Feed
- Files changed:
  - src/lib/useSessionMovies.ts (new) - hook for synchronized feed access using session.movies
  - src/app/session.tsx (updated) - uses session movies for Together mode, syncs swipes to session
- **Learnings for future iterations:**
  - useSessionMovies(session, countryCode) returns currentMovie, allMovies, isSessionMode, totalRounds, currentRound
  - Session.movies[] already contains pre-generated movie IDs from generateSessionMovies() in spellage.tsx
  - Together mode (isTogetherMode): session exists AND spellageSolo is false
  - isSessionMode: session has movies array with items
  - recordSwipeToSession() updates session.swipes[deviceId][movieId] and syncs to registry
  - Match detection: check if all participants have liked the same movie
  - Round advancement: happens when all participants have swiped on current movie
  - Helper functions exported: hasDeviceSwiped(), getMovieSwipes(), haveAllParticipantsSwiped(), isMovieMatch(), getSessionMatches()
  - Round indicator UI shows "Round X of Y" in Together mode
  - FeedEngine only created for Solo mode - Together mode uses useSessionMovies
  - updateSessionInRegistry() syncs session state for other participants
---

## 2026-01-23 - US-015
- What was implemented: Blind Choice UI with reveal animation
- Files changed:
  - src/components/MovieCard.tsx (updated) - added reveal animation for blind mode
- **Learnings for future iterations:**
  - MovieCard already had blindMode and isRevealed props - just needed animation
  - revealOpacity shared value initialized based on blindMode && !isRevealed state
  - useEffect triggers animation when isRevealed changes from false to true
  - 400ms fade-in with Easing.out(Easing.ease) feels smooth and natural
  - Animated.View wrapper needed for gradient since LinearGradient doesn't support style prop with animated values
  - Streaming icons are shown OUTSIDE MovieCard in session.tsx (bottom section), so they're always visible regardless of blind mode
  - showTitle = !blindMode || isRevealed - title elements only render when should be visible
  - revealAnimatedStyle only applied when blindMode is true (otherwise opacity stays at 1)
---

