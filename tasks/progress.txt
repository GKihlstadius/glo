## Codebase Patterns
- Use NativeWind (Tailwind) for styling with cn() helper from src/lib/cn.ts for conditional classes
- expo-av Video component for native video playback
- Zustand for local state management (src/lib/store.ts)
- TMDB API integration in src/lib/tmdb.ts
- Existing trailer system code in src/lib/trailer.ts and src/lib/trailer-system.ts (currently disabled)
- MovieCard component at src/components/MovieCard.tsx
- SwipeCard component at src/components/SwipeCard.tsx handles gestures
- Spell√§ge screen at src/app/spellage.tsx

- TrailerPlayer persistent player architecture at src/components/TrailerPlayer.tsx
- TrailerSource type: { type: 'native' | 'youtube' | 'apple', uri: string, startTime?: number, endTime?: number }
- useTrailerSource(movieId) hook at src/lib/useTrailerSource.ts for fetching trailer sources
- TrailerGate module at src/lib/trailer-gate.ts for autoplay stability tracking
- getNativeTrailerSource(movie) at src/lib/native-trailer-source.ts for MP4/HLS sources

---

## 2026-01-21 - US-001
- What was implemented: Persistent Video Player Architecture
- Files changed: src/components/TrailerPlayer.tsx (new)
- **Learnings for future iterations:**
  - expo-av Video component is used for native video playback, though it's deprecated in favor of expo-video
  - The player uses imperative API via forwardRef/useImperativeHandle pattern
  - Visibility controlled via opacity (not mount/unmount) for instant control
  - z-index 100 places player above card stack
  - stopAsync() is called without await for <16ms instant stop requirement
---

## 2026-01-21 - US-002
- What was implemented: Source-Agnostic Video Loader
- Files changed: src/lib/useTrailerSource.ts (new)
- **Learnings for future iterations:**
  - useTrailerSource hook uses React Query for data fetching and caching
  - AsyncStorage used for persistent 7-day TTL cache
  - Sources checked in priority order: native > YouTube > Apple
  - Negative results (null) are also cached to avoid repeated lookups
  - Uses React Query's staleTime and gcTime for in-memory caching
  - getTrailer() from trailer.ts expects full Movie type but only uses movie.id - use createMinimalMovie helper
  - Re-export TrailerSource type from useTrailerSource for convenience
---

## 2026-01-21 - US-003
- What was implemented: Autoplay Gate System
- Files changed: src/lib/trailer-gate.ts (new)
- **Learnings for future iterations:**
  - Gate requires 50 consecutive successes for both autoplay and swipeStop
  - Session failure is tracked in-memory only (doesn't persist across restarts)
  - Metrics persist to AsyncStorage but reset on app version update
  - recordBlinkStop() treats videos stopping within 2 seconds as failures
  - Gate state can be checked synchronously via isGatePassed()
---

## 2026-01-21 - US-004
- What was implemented: Native Video Source Integration (MP4/HLS)
- Files changed: src/lib/native-trailer-source.ts (new), src/lib/useTrailerSource.ts (updated)
- **Learnings for future iterations:**
  - TMDB API does NOT provide direct MP4/HLS URLs - only YouTube/Vimeo video keys
  - Apple iTunes Search API can be used to find movie preview URLs (HLS streams)
  - The useTrailerSource hook only receives movieId, not full Movie object - limits native source lookup
  - For full Apple iTunes search, need movie title and year (createMinimalMovie has empty values)
  - URL validation uses HEAD request to check content-type for video MIME types
  - CDN_PATTERNS array is extensible for future studio-specific CDN integrations
  - Native sources have priority over YouTube/Apple in the trailer source resolution
---

