## Codebase Patterns
- Use NativeWind (Tailwind) for styling with cn() helper from src/lib/cn.ts for conditional classes
- expo-av Video component for native video playback
- Zustand for local state management (src/lib/store.ts)
- TMDB API integration in src/lib/tmdb.ts
- Existing trailer system code in src/lib/trailer.ts and src/lib/trailer-system.ts (currently disabled)
- MovieCard component at src/components/MovieCard.tsx
- SwipeCard component at src/components/SwipeCard.tsx handles gestures
- Spell√§ge screen at src/app/spellage.tsx

- TrailerPlayer persistent player architecture at src/components/TrailerPlayer.tsx
- TrailerSource type: { type: 'native' | 'youtube' | 'apple', uri: string, startTime?: number, endTime?: number }
- useTrailerSource(movieId) hook at src/lib/useTrailerSource.ts for fetching trailer sources
- TrailerGate module at src/lib/trailer-gate.ts for autoplay stability tracking
- getNativeTrailerSource(movie) at src/lib/native-trailer-source.ts for MP4/HLS sources
- getYouTubeTrailerSource(movie) at src/lib/youtube-trailer-source.ts for YouTube embeds
- YouTube embeds use youtube-nocookie.com for privacy-enhanced playback
- isVideoEmbeddable(videoId) uses oEmbed API to validate embed availability
- getAppleTrailerSource(movie) at src/lib/apple-trailer-source.ts for Apple Movie Previews
- Apple iTunes Search API returns previewUrl for movie trailers (HLS/M4V format)
- Apple sources return type 'apple' to distinguish from native (type 'native') sources

---

## 2026-01-21 - US-001
- What was implemented: Persistent Video Player Architecture
- Files changed: src/components/TrailerPlayer.tsx (new)
- **Learnings for future iterations:**
  - expo-av Video component is used for native video playback, though it's deprecated in favor of expo-video
  - The player uses imperative API via forwardRef/useImperativeHandle pattern
  - Visibility controlled via opacity (not mount/unmount) for instant control
  - z-index 100 places player above card stack
  - stopAsync() is called without await for <16ms instant stop requirement
---

## 2026-01-21 - US-002
- What was implemented: Source-Agnostic Video Loader
- Files changed: src/lib/useTrailerSource.ts (new)
- **Learnings for future iterations:**
  - useTrailerSource hook uses React Query for data fetching and caching
  - AsyncStorage used for persistent 7-day TTL cache
  - Sources checked in priority order: native > YouTube > Apple
  - Negative results (null) are also cached to avoid repeated lookups
  - Uses React Query's staleTime and gcTime for in-memory caching
  - getTrailer() from trailer.ts expects full Movie type but only uses movie.id - use createMinimalMovie helper
  - Re-export TrailerSource type from useTrailerSource for convenience
---

## 2026-01-21 - US-003
- What was implemented: Autoplay Gate System
- Files changed: src/lib/trailer-gate.ts (new)
- **Learnings for future iterations:**
  - Gate requires 50 consecutive successes for both autoplay and swipeStop
  - Session failure is tracked in-memory only (doesn't persist across restarts)
  - Metrics persist to AsyncStorage but reset on app version update
  - recordBlinkStop() treats videos stopping within 2 seconds as failures
  - Gate state can be checked synchronously via isGatePassed()
---

## 2026-01-21 - US-004
- What was implemented: Native Video Source Integration (MP4/HLS)
- Files changed: src/lib/native-trailer-source.ts (new), src/lib/useTrailerSource.ts (updated)
- **Learnings for future iterations:**
  - TMDB API does NOT provide direct MP4/HLS URLs - only YouTube/Vimeo video keys
  - Apple iTunes Search API can be used to find movie preview URLs (HLS streams)
  - The useTrailerSource hook only receives movieId, not full Movie object - limits native source lookup
  - For full Apple iTunes search, need movie title and year (createMinimalMovie has empty values)
  - URL validation uses HEAD request to check content-type for video MIME types
  - CDN_PATTERNS array is extensible for future studio-specific CDN integrations
  - Native sources have priority over YouTube/Apple in the trailer source resolution
---

## 2026-01-21 - US-005
- What was implemented: YouTube Source Integration
- Files changed: src/lib/youtube-trailer-source.ts (new), src/lib/useTrailerSource.ts (updated)
- **Learnings for future iterations:**
  - youtube-nocookie.com provides privacy-enhanced embeds (no tracking cookies)
  - YouTube oEmbed API at youtube.com/oembed can check embeddability without API key
  - Video ID format is 11 characters: letters, numbers, hyphens, underscores
  - Embed parameters: autoplay=1, mute=1, playsinline=1, controls=0 for clean inline playback
  - enablejsapi=1 allows JavaScript control of embedded player
  - getTrailer() from trailer.ts provides official trailer lookup with channel priority
  - Embeddability validation prevents showing blocked/unavailable videos
---

## 2026-01-21 - US-006
- What was implemented: Apple Movie Previews Integration
- Files changed: src/lib/apple-trailer-source.ts (new), src/lib/useTrailerSource.ts (updated)
- **Learnings for future iterations:**
  - Apple iTunes Search API endpoint: https://itunes.apple.com/search?term={query}&media=movie&entity=movie
  - previewUrl field contains HLS/M4V video URL for trailer playback
  - Best match found by scoring title similarity (exact match > contains > word overlap) and year proximity
  - Apple preview URLs come from domains like video-ssl.itunes.apple.com, is{N}-ssl.mzstatic.com
  - HEAD request validation can be lenient for Apple URLs - pattern matching is sufficient fallback
  - transformToHlsUrl() can convert .mp4 to .m4v for better quality
  - Apple sources return type 'apple' distinct from 'native' type used by other HLS sources
  - getAppleSourceByTrackId() available for direct track ID lookup via itunes.apple.com/lookup
- useAutoplay(options) hook at src/lib/useAutoplay.ts for autoplay timing and triggering
- Random delay between 900-1400ms per spec for natural autoplay feel
- Autoplay conditions: isTopCard + hasTrailerSource + gatePassed + !isGestureActive
- onGestureStart() immediately cancels any pending autoplay
- 300ms debounce after swipe to prevent autoplay during rapid swiping
- recordAutoplayStarted()/recordAutoplayFailed() for gate metric tracking
- useSwipeStop hook at src/lib/useSwipeStop.ts for instant trailer stop on swipe
- SwipeCard accepts onGestureStart/onGestureEnd props for trailer integration
- performance.now() used for precise timing measurement of stop operations
- Stop operations failing >100ms threshold are recorded as failures to gate
---

## 2026-01-21 - US-007
- What was implemented: Autoplay Delay & Trigger Logic
- Files changed: src/lib/useAutoplay.ts (new)
- **Learnings for future iterations:**
  - useAutoplay hook handles WHEN to play, not the actual playback
  - Autoplay conditions checked: isTopCard, hasTrailerSource, gatePassed, !isGestureActive
  - Random delay (900-1400ms) prevents mechanical feel
  - Debounce prevents autoplay during rapid swiping (300ms after last swipe)
  - Gate checked twice: once at start, once after delay (could fail during delay)
  - onGestureStart() must be called from gesture handler's onStart for instant cancellation
  - hasAutoplayedRef prevents multiple triggers per card
  - reset() should be called when movie changes to allow new autoplay
  - State changes use functional updates to avoid stale closures
---

